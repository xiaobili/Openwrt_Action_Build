name: ç¼–è¯‘ ImmortalWrt å›ºä»¶

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - "ç¼–è¯‘ LEDE å›ºä»¶"
    types:
      - completed

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  TZ: Asia/Shanghai
  # åŠŸèƒ½å¼€å…³
  CACHE_TOOLCHAIN: true
  FIRMWARE_RELEASE: true
  FIX_GOLANG: true

jobs:
  prepare:
    name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
    runs-on: ubuntu-22.04
    outputs:
      commit_author: ${{ steps.git_info.outputs.commit_author }}
      commit_date: ${{ steps.git_info.outputs.commit_date }}
      commit_message: ${{ steps.git_info.outputs.commit_message }}
      commit_hash: ${{ steps.git_info.outputs.commit_hash }}

    steps:
      - name: æœ€å¤§åŒ–æ„å»ºç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100
          root-reserve-mb: 1024

      - name: æ˜¾ç¤ºç£ç›˜ä¿¡æ¯
        run: |
          set -xe
          df -H

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@main

      - name: å…‹éš†æºç å¹¶è·å– Git ä¿¡æ¯
        id: git_info
        run: |
          df -hT "$GITHUB_WORKSPACE"
          git clone -b "$REPO_BRANCH" --single-branch --filter=blob:none "$REPO_URL" openwrt
          cd openwrt
          echo "commit_author=ä½œè€…: $(git show -s --date=short --format='%an')" >> "$GITHUB_OUTPUT"
          echo "commit_date=æ—¶é—´: $(git show -s --date=short --format='%ci')" >> "$GITHUB_OUTPUT"
          echo "commit_message=å†…å®¹: $(git show -s --date=short --format='%s')" >> "$GITHUB_OUTPUT"
          echo "commit_hash=hash: $(git show -s --date=short --format='%H')" >> "$GITHUB_OUTPUT"

  build:
    name: ç¼–è¯‘ ${{ matrix.build_type }} ç‰ˆæœ¬
    needs: prepare
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - build_type: Full
            diy_script: scripts/customize-full.sh
            config: configs/immortalwrt-full.config
          - build_type: Mini
            diy_script: scripts/customize-mini.sh
            config: configs/immortalwrt-mini.config
      max-parallel: 2
      fail-fast: false

    steps:
      - name: æ£€æŸ¥ç³»ç»Ÿæ€§èƒ½
        run: |
          echo "âš ï¸  è­¦å‘Š: æœåŠ¡å™¨æ€§èƒ½æœ‰é™ã€‚"
          echo "-------------------------- CPU ä¿¡æ¯ --------------------------"
          echo "ç‰©ç† CPU æ•°é‡: $(grep -c '^physical id' /proc/cpuinfo | sort -u | wc -l)"
          echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
          echo "CPU å‹å·: $(grep -m1 'name' /proc/cpuinfo | awk -F: '{print $2}')"
          echo "-------------------------- å†…å­˜ä¿¡æ¯ --------------------------"
          sudo lshw -short -C memory | grep GiB || echo "æœªæ‰¾åˆ° GiB å†…å­˜"
          echo "-------------------------- ç£ç›˜ä¿¡æ¯ --------------------------"
          df -hT

      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo systemctl daemon-reload
          sudo apt-get autoremove --purge -y
          sudo apt-get clean -y
          sudo apt-get install -y \
            python3-socks python3-unidecode scdoc ack antlr3 asciidoc autoconf \
            automake autopoint binutils bison build-essential bzip2 ccache clang \
            cmake cpio curl device-tree-compiler flex gawk gcc-multilib \
            g++-multilib gettext genisoimage git gperf haveged help2man intltool \
            libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
            libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev \
            libpython3-dev libreadline-dev libssl-dev libtool llvm lrzsz msmtp \
            ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools \
            python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
            swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo timedatectl set-timezone "$TZ"

      - name: æœ€å¤§åŒ–æ„å»ºç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100
          root-reserve-mb: 1024

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@main

      - name: è®¾ç½®è„šæœ¬
        id: setup
        run: |
          chmod +x "$GITHUB_WORKSPACE"/scripts/*.sh
          chmod +x "$GITHUB_WORKSPACE"/patches/*.sh
          df -hT "$GITHUB_WORKSPACE"
          git clone -b "$REPO_BRANCH" --single-branch --filter=blob:none "$REPO_URL" openwrt
          echo "OPENWRT_PATH=$PWD/openwrt" >> "$GITHUB_OUTPUT"

      - name: ç”Ÿæˆç¼–è¯‘å˜é‡
        id: vars
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          cp "$GITHUB_WORKSPACE/${{ matrix.config }}" .config
          make defconfig > /dev/null 2>&1

          source_repo=$(echo "$REPO_URL" | awk -F '/' '{print $NF}')
          device_target=$(grep CONFIG_TARGET_BOARD .config | awk -F '"' '{print $2}')
          device_subtarget=$(grep CONFIG_TARGET_SUBTARGET .config | awk -F '"' '{print $2}')
          use_apk=$(grep -q "^CONFIG_USE_APK=y$" .config && echo true || echo false)

          echo "SOURCE_REPO=$source_repo" >> "$GITHUB_OUTPUT"
          echo "SOURCE_REPO=$source_repo" >> "$GITHUB_ENV"
          echo "DEVICE_TARGET=$device_target" >> "$GITHUB_OUTPUT"
          echo "DEVICE_TARGET=$device_target" >> "$GITHUB_ENV"
          echo "DEVICE_SUBTARGET=$device_subtarget" >> "$GITHUB_OUTPUT"
          echo "DEVICE_SUBTARGET=$device_subtarget" >> "$GITHUB_ENV"
          echo "USE_APK=$use_apk" >> "$GITHUB_OUTPUT"

      - name: ç¼“å­˜å·¥å…·é“¾
        if: env.CACHE_TOOLCHAIN == 'true'
        uses: HiGarfield/cachewrtbuild@main
        with:
          ccache: false
          mixkey: ${{ steps.vars.outputs.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ steps.vars.outputs.DEVICE_TARGET }}-${{ steps.vars.outputs.DEVICE_SUBTARGET }}-${{ matrix.build_type }}
          prefix: ${{ steps.setup.outputs.OPENWRT_PATH }}

      - name: åº”ç”¨è½¯ä»¶æº
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          "$GITHUB_WORKSPACE"/patches/update-network.sh
          "$GITHUB_WORKSPACE"/scripts/setup-feeds.sh

      - name: æ›´æ–°è½¯ä»¶æº
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          ./scripts/feeds update -a

      - name: åº”ç”¨è¡¥ä¸
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          "$GITHUB_WORKSPACE"/patches/fix-versions.sh

      - name: å®‰è£…è½¯ä»¶åŒ…
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          ./scripts/feeds install -a

      - name: åº”ç”¨è‡ªå®šä¹‰é…ç½®
        run: |
          [ -e files ] && rm -rf files
          [ -e "$GITHUB_WORKSPACE/files" ] && cp -r "$GITHUB_WORKSPACE/files" "${{ steps.setup.outputs.OPENWRT_PATH }}"/files
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          cp "$GITHUB_WORKSPACE/${{ matrix.config }}" .config
          SOURCE_TYPE=ImmortalWrt "$GITHUB_WORKSPACE/${{ matrix.diy_script }}"

      - name: ä¸‹è½½ä¾èµ–
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          make defconfig
          "$GITHUB_WORKSPACE"/scripts/build.sh download
          find dl -size -1024c -exec ls -l {} \; -exec rm -f {} \;

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          mkdir -p files/etc/uci-defaults
          cp "$GITHUB_WORKSPACE"/patches/init-settings.sh files/etc/uci-defaults/99-init-settings
          echo "ä½¿ç”¨ $(nproc) çº¿ç¨‹ç¼–è¯‘..."
          "$GITHUB_WORKSPACE"/scripts/build.sh compile || make -j"$(nproc)" V=s
          echo "status=success" >> "$GITHUB_OUTPUT"
          echo "FILE_DATE=$(date +"%Y.%m.%d")" >> "$GITHUB_OUTPUT"

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: æ•´ç†å›ºä»¶
        id: organize
        if: steps.compile.outputs.status == 'success'
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"/bin/targets/*/*
          cat sha256sums
          cp "${{ steps.setup.outputs.OPENWRT_PATH }}"/.config "build-${{ matrix.build_type }}.config"

          if [ "${{ steps.vars.outputs.USE_APK }}" = "true" ]; then
            mv -f "${{ steps.setup.outputs.OPENWRT_PATH }}"/bin/packages/*/*/*.apk packages 2>/dev/null || true
          else
            mv -f "${{ steps.setup.outputs.OPENWRT_PATH }}"/bin/packages/*/*/*.ipk packages 2>/dev/null || true
          fi

          tar -zcf "Packages-${{ matrix.build_type }}.tar.gz" packages 2>/dev/null || true
          rm -rf packages feeds.buildinfo version.buildinfo

          kernel_version=$(jq -r '.linux_kernel.version // "unknown"' profiles.json)
          echo "KERNEL_VERSION=$kernel_version" >> "$GITHUB_OUTPUT"
          echo "FIRMWARE_PATH=$PWD" >> "$GITHUB_OUTPUT"

      - name: æš‚å­˜å›ºä»¶ç”¨äºå‘å¸ƒ
        if: steps.compile.outputs.status == 'success'
        run: |
          mkdir -p "$GITHUB_WORKSPACE"/firmware/${{ matrix.build_type }}
          cd "${{ steps.organize.outputs.FIRMWARE_PATH }}"

          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "$GITHUB_WORKSPACE/firmware/${{ matrix.build_type }}/${{ matrix.build_type }}_$file"
            fi
          done

      - name: ä¸Šä¼ å›ºä»¶äº§ç‰©
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
        uses: actions/upload-artifact@main
        with:
          name: firmware-${{ matrix.build_type }}
          path: ${{ github.workspace }}/firmware/${{ matrix.build_type }}
          retention-days: 1

  release:
    name: å‘å¸ƒå›ºä»¶
    needs: [prepare, build]
    runs-on: ubuntu-22.04
    if: always() && needs.Build.result == 'success'

    steps:
      - name: ä¸‹è½½å®Œæ•´ç‰ˆå›ºä»¶
        uses: actions/download-artifact@main
        with:
          name: firmware-Full
          path: ./firmware-all

      - name: ä¸‹è½½ç²¾ç®€ç‰ˆå›ºä»¶
        uses: actions/download-artifact@main
        with:
          name: firmware-Mini
          path: ./firmware-all

      - name: å‡†å¤‡å‘å¸ƒå˜é‡
        id: release_vars
        run: |
          cd "$GITHUB_WORKSPACE"/firmware-all
          ls -lah

          file_date=$(date +"%Y.%m.%d")
          full_kernel=$(jq -r '.linux_kernel.version // "unknown"' Full_profiles.json)
          mini_kernel=$(jq -r '.linux_kernel.version // "unknown"' Mini_profiles.json)
          full_version=$(jq -r '.version_number // "unknown"' Full_profiles.json)
          mini_version=$(jq -r '.version_number // "unknown"' Mini_profiles.json)

          echo "FILE_DATE=$file_date" >> "$GITHUB_OUTPUT"
          echo "FULL_KERNEL_VERSION=$full_kernel" >> "$GITHUB_OUTPUT"
          echo "MINI_KERNEL_VERSION=$mini_kernel" >> "$GITHUB_OUTPUT"
          echo "FULL_FIRMWARE_VERSION=$full_version" >> "$GITHUB_OUTPUT"
          echo "MINI_FIRMWARE_VERSION=$mini_version" >> "$GITHUB_OUTPUT"

      - name: åˆ›å»ºå‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with:
          name: R${{ steps.release_vars.outputs.FILE_DATE }}_ImmortalWrt_Combined
          tag_name: R${{ steps.release_vars.outputs.FILE_DATE }}_ImmortalWrt_Combined
          token: ${{ secrets.GH_TOKEN }}
          files: ${{ github.workspace }}/firmware-all/*
          body: |
            **OpenWrt ImmortalWrt ç»„åˆå›ºä»¶**

            ### ğŸ“‹ å›ºä»¶ä¿¡æ¯
            - ğŸ’» å¹³å°æ¶æ„: x86_64
            - ğŸ“¦ ç¼–è¯‘ç‰ˆæœ¬: å®Œæ•´ç‰ˆ + ç²¾ç®€ç‰ˆ ç»„åˆ
            - âš½ å›ºä»¶æºç : ImmortalWrt
            - ğŸ’ æºç åˆ†æ”¯: master
            - ğŸ§ å†…æ ¸ç‰ˆæœ¬:
              - å®Œæ•´ç‰ˆ: ${{ steps.release_vars.outputs.FULL_KERNEL_VERSION }}
              - ç²¾ç®€ç‰ˆ: ${{ steps.release_vars.outputs.MINI_KERNEL_VERSION }}
            - ğŸŒ é»˜è®¤åœ°å€: 192.168.1.1
            - ğŸ”‘ é»˜è®¤å¯†ç : æ— 

            ### ğŸ“ æ–‡ä»¶è¯´æ˜
            - **Full_*** : å®Œæ•´ç‰ˆå›ºä»¶
            - **Mini_*** : ç²¾ç®€ç‰ˆå›ºä»¶

            ### ğŸ“ ç‰ˆæœ¬ä¿¡æ¯
            - å®Œæ•´ç‰ˆ: ${{ steps.release_vars.outputs.FULL_FIRMWARE_VERSION }}
            - ç²¾ç®€ç‰ˆ: ${{ steps.release_vars.outputs.MINI_FIRMWARE_VERSION }}

            ### ğŸ”— æºç æ›´æ–°
            - ${{ needs.prepare.outputs.commit_author }}
            - ${{ needs.prepare.outputs.commit_date }}
            - ${{ needs.prepare.outputs.commit_message }}
            - ${{ needs.prepare.outputs.commit_hash }}
