name: ç¼–è¯‘ LEDE & ImmortalWrt ç»„åˆå›ºä»¶

on:
  workflow_dispatch:
  schedule:
    - cron: 0 16 */4 * *

env:
  TZ: Asia/Shanghai
  # åŠŸèƒ½å¼€å…³
  CACHE_TOOLCHAIN: true
  FIRMWARE_RELEASE: true
  FIX_GOLANG: true
  FIX_RUST: false
  FIX_SS_LIBEV: false

jobs:
  prepare:
    name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
    runs-on: ubuntu-22.04

    outputs:
      lede_commit_author: ${{ steps.lede_git_info.outputs.commit_author }}
      lede_commit_date: ${{ steps.lede_git_info.outputs.commit_date }}
      lede_commit_message: ${{ steps.lede_git_info.outputs.commit_message }}
      lede_commit_hash: ${{ steps.lede_git_info.outputs.commit_hash }}
      immortal_commit_author: ${{ steps.immortal_git_info.outputs.commit_author }}
      immortal_commit_date: ${{ steps.immortal_git_info.outputs.commit_date }}
      immortal_commit_message: ${{ steps.immortal_git_info.outputs.commit_message }}
      immortal_commit_hash: ${{ steps.immortal_git_info.outputs.commit_hash }}

    steps:
      - name: æœ€å¤§åŒ–æ„å»ºç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100
          root-reserve-mb: 1024

      - name: æ˜¾ç¤ºç£ç›˜ä¿¡æ¯
        run: |
          set -xe
          df -H

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@main

      - name: å…‹éš†å¹¶è·å– LEDE æºç ä¿¡æ¯
        id: lede_git_info
        run: |
          df -hT "$GITHUB_WORKSPACE"
          git clone -b master --single-branch --filter=blob:none https://github.com/coolsnowwolf/lede.git lede-src
          cd lede-src
          echo "commit_author=ä½œè€…: $(git show -s --date=short --format='%an')" >> "$GITHUB_OUTPUT"
          echo "commit_date=æ—¶é—´: $(git show -s --date=short --format='%ci')" >> "$GITHUB_OUTPUT"
          echo "commit_message=å†…å®¹: $(git show -s --date=short --format='%s')" >> "$GITHUB_OUTPUT"
          echo "commit_hash=hash: $(git show -s --date=short --format='%H')" >> "$GITHUB_OUTPUT"

      - name: å…‹éš†å¹¶è·å– ImmortalWrt æºç ä¿¡æ¯
        id: immortal_git_info
        run: |
          df -hT "$GITHUB_WORKSPACE"
          git clone -b master --single-branch --filter=blob:none https://github.com/immortalwrt/immortalwrt immortalwrt-src
          cd immortalwrt-src
          echo "commit_author=ä½œè€…: $(git show -s --date=short --format='%an')" >> "$GITHUB_OUTPUT"
          echo "commit_date=æ—¶é—´: $(git show -s --date=short --format='%ci')" >> "$GITHUB_OUTPUT"
          echo "commit_message=å†…å®¹: $(git show -s --date=short --format='%s')" >> "$GITHUB_OUTPUT"
          echo "commit_hash=hash: $(git show -s --date=short --format='%H')" >> "$GITHUB_OUTPUT"

  build:
    name: ç¼–è¯‘ ${{ matrix.source_type }} å›ºä»¶
    needs: prepare
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - source_type: LEDE
            repo_url: https://github.com/coolsnowwolf/lede.git
            repo_branch: master
            config: configs/lede-full.config
            diy_script: scripts/customize-full.sh
          - source_type: ImmortalWrt
            repo_url: https://github.com/immortalwrt/immortalwrt
            repo_branch: master
            config: configs/immortalwrt-full.config
            diy_script: scripts/customize-full.sh
      max-parallel: 2
      fail-fast: false

    steps:
      - name: æ£€æŸ¥ç³»ç»Ÿæ€§èƒ½
        run: |
          echo "âš ï¸  è­¦å‘Š: æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„ CPU æ€§èƒ½ï¼"
          echo "å·²çŸ¥ CPU å‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673"
          echo "-------------------------- CPU ä¿¡æ¯ --------------------------"
          echo "ç‰©ç† CPU æ•°é‡: $(grep -c '^physical id' /proc/cpuinfo | sort -u | wc -l)"
          echo "CPU æ ¸å¿ƒæ•°: $(nproc)"
          echo "CPU å‹å·: $(grep -m1 'name' /proc/cpuinfo | awk -F: '{print $2}')"
          echo "-------------------------- å†…å­˜ä¿¡æ¯ --------------------------"
          sudo lshw -short -C memory | grep GiB || echo "æœªæ‰¾åˆ° GiB å†…å­˜"
          echo "-------------------------- ç£ç›˜ä¿¡æ¯ --------------------------"
          df -hT

      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo systemctl daemon-reload
          sudo apt-get autoremove --purge -y
          sudo apt-get clean -y
          sudo apt-get install -y \
            python3-socks python3-unidecode scdoc ack antlr3 asciidoc autoconf \
            automake autopoint binutils bison build-essential bzip2 ccache clang \
            cmake cpio curl device-tree-compiler flex gawk gcc-multilib \
            g++-multilib gettext genisoimage git gperf haveged help2man intltool \
            libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
            libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev \
            libpython3-dev libreadline-dev libssl-dev libtool llvm lrzsz msmtp \
            ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools \
            python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
            swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo timedatectl set-timezone "$TZ"

      - name: æœ€å¤§åŒ–æ„å»ºç©ºé—´
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 1024
          temp-reserve-mb: 100
          root-reserve-mb: 1024

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@main

      - name: è®¾ç½®è„šæœ¬
        id: setup
        run: |
          chmod +x "$GITHUB_WORKSPACE"/scripts/*.sh
          chmod +x "$GITHUB_WORKSPACE"/patches/*.sh
          df -hT "$GITHUB_WORKSPACE"
          git clone -b ${{ matrix.repo_branch }} --single-branch --filter=blob:none ${{ matrix.repo_url }} "openwrt-${{ matrix.source_type }}"
          echo "OPENWRT_PATH=$PWD/openwrt-${{ matrix.source_type }}" >> "$GITHUB_OUTPUT"
          echo "SOURCE_TYPE=${{ matrix.source_type }}" >> "$GITHUB_OUTPUT"
          echo "SOURCE_TYPE=${{ matrix.source_type }}" >> "$GITHUB_ENV"

      - name: ç”Ÿæˆç¼–è¯‘å˜é‡
        id: vars
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          cp "$GITHUB_WORKSPACE/${{ matrix.config }}" .config
          make defconfig > /dev/null 2>&1

          source_repo=$(echo "${{ matrix.repo_url }}" | awk -F '/' '{print $NF}')
          device_target=$(grep CONFIG_TARGET_BOARD .config | awk -F '"' '{print $2}')
          device_subtarget=$(grep CONFIG_TARGET_SUBTARGET .config | awk -F '"' '{print $2}')
          use_apk=$(grep -q "^CONFIG_USE_APK=y$" .config && echo true || echo false)

          echo "SOURCE_REPO=$source_repo" >> "$GITHUB_OUTPUT"
          echo "SOURCE_REPO=$source_repo" >> "$GITHUB_ENV"
          echo "DEVICE_TARGET=$device_target" >> "$GITHUB_OUTPUT"
          echo "DEVICE_TARGET=$device_target" >> "$GITHUB_ENV"
          echo "DEVICE_SUBTARGET=$device_subtarget" >> "$GITHUB_OUTPUT"
          echo "DEVICE_SUBTARGET=$device_subtarget" >> "$GITHUB_ENV"
          echo "USE_APK=$use_apk" >> "$GITHUB_OUTPUT"

      - name: ç¼“å­˜å·¥å…·é“¾
        if: env.CACHE_TOOLCHAIN == 'true'
        uses: HiGarfield/cachewrtbuild@main
        with:
          ccache: false
          mixkey: ${{ steps.vars.outputs.SOURCE_REPO }}-${{ matrix.repo_branch }}-${{ steps.vars.outputs.DEVICE_TARGET }}-${{ steps.vars.outputs.DEVICE_SUBTARGET }}-FULL
          prefix: ${{ steps.setup.outputs.OPENWRT_PATH }}

      - name: åº”ç”¨è½¯ä»¶æº
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          "$GITHUB_WORKSPACE"/patches/update-network.sh
          "$GITHUB_WORKSPACE"/scripts/setup-feeds.sh

      - name: æ›´æ–°è½¯ä»¶æº
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          ./scripts/feeds update -a

      - name: åº”ç”¨è¡¥ä¸
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          "$GITHUB_WORKSPACE"/patches/fix-versions.sh

      - name: å®‰è£…è½¯ä»¶åŒ…
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          ./scripts/feeds install -a

      - name: åº”ç”¨è‡ªå®šä¹‰é…ç½®
        run: |
          [ -e files ] && rm -rf files
          [ -e "$GITHUB_WORKSPACE/files" ] && cp -r "$GITHUB_WORKSPACE/files" "${{ steps.setup.outputs.OPENWRT_PATH }}"/files
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          cp "$GITHUB_WORKSPACE/${{ matrix.config }}" .config
          SOURCE_TYPE=${{ matrix.source_type }} "$GITHUB_WORKSPACE/${{ matrix.diy_script }}"

      - name: ä¸‹è½½ä¾èµ–
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          make defconfig
          "$GITHUB_WORKSPACE"/scripts/build.sh download
          find dl -size -1024c -exec ls -l {} \; -exec rm -f {} \;

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"
          mkdir -p files/etc/uci-defaults
          cp "$GITHUB_WORKSPACE"/patches/init-settings.sh files/etc/uci-defaults/99-init-settings
          echo "ä½¿ç”¨ $(nproc) çº¿ç¨‹ç¼–è¯‘..."
          "$GITHUB_WORKSPACE"/scripts/build.sh compile || make -j"$(nproc)" V=s
          echo "status=success" >> "$GITHUB_OUTPUT"
          echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> "$GITHUB_OUTPUT"
          echo "FILE_DATE=$(date +"%Y.%m.%d")" >> "$GITHUB_OUTPUT"

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: æ•´ç† ${{ matrix.source_type }} ç‰ˆæœ¬å›ºä»¶
        id: organize
        if: steps.compile.outputs.status == 'success'
        run: |
          cd "${{ steps.setup.outputs.OPENWRT_PATH }}"/bin/targets/*/*
          cat sha256sums
          cp "${{ steps.setup.outputs.OPENWRT_PATH }}"/.config "build-${{ matrix.source_type }}-FULL.config"

          if [ "${{ steps.vars.outputs.USE_APK }}" = "true" ]; then
            mv -f "${{ steps.setup.outputs.OPENWRT_PATH }}"/bin/packages/*/*/*.apk packages 2>/dev/null || true
          else
            mv -f "${{ steps.setup.outputs.OPENWRT_PATH }}"/bin/packages/*/*/*.ipk packages 2>/dev/null || true
          fi

          tar -zcf "Packages-${{ matrix.source_type }}-FULL.tar.gz" packages 2>/dev/null || true
          rm -rf packages feeds.buildinfo version.buildinfo
          echo "FIRMWARE_PATH=$PWD" >> "$GITHUB_OUTPUT"
          echo "BUILD_TYPE=FULL" >> "$GITHUB_OUTPUT"
          echo "SOURCE_TYPE=${{ matrix.source_type }}" >> "$GITHUB_OUTPUT"

      - name: ä¿å­˜å›ºä»¶è‡³ä¸´æ—¶ç›®å½•
        if: steps.compile.outputs.status == 'success'
        run: |
          echo "FIRMWARE_PATH: ${{ steps.organize.outputs.FIRMWARE_PATH }}"
          echo "æ£€æŸ¥æºç›®å½•å†…å®¹:"
          ls -lah "${{ steps.organize.outputs.FIRMWARE_PATH }}" || echo "æºç›®å½•ä¸å­˜åœ¨"

          mkdir -p "$GITHUB_WORKSPACE"/firmware/${{ matrix.source_type }}
          if [ -d "${{ steps.organize.outputs.FIRMWARE_PATH }}" ]; then
            cd "${{ steps.organize.outputs.FIRMWARE_PATH }}"
            count=0
            for file in *; do
              if [ -f "$file" ]; then
                mv "$file" "$GITHUB_WORKSPACE/firmware/${{ matrix.source_type }}/${{ matrix.source_type }}_$file"
                count=$((count+1))
                echo "å·²ç§»åŠ¨: $file"
              fi
            done
            echo "å…±ç§»åŠ¨ $count ä¸ªæ–‡ä»¶"
          else
            echo "é”™è¯¯: FIRMWARE_PATH ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          echo "ç›®æ ‡ç›®å½•å†…å®¹:"
          ls -lah "$GITHUB_WORKSPACE"/firmware/${{ matrix.source_type }} || echo "ç›®æ ‡ç›®å½•ä¸ºç©º"

      - name: ä¸Šä¼ å›ºä»¶äº§ç‰©
        if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
        uses: actions/upload-artifact@main
        with:
          name: firmware-${{ matrix.source_type }}-FULL
          path: ${{ github.workspace }}/firmware/${{ matrix.source_type }}
          retention-days: 1

  release:
    name: ç»Ÿä¸€å‘å¸ƒå›ºä»¶
    needs: [prepare, build]
    runs-on: ubuntu-22.04
    if: always()

    steps:
      - name: æ£€æŸ¥ Build ä»»åŠ¡çŠ¶æ€
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Build ä»»åŠ¡å¤±è´¥ï¼Œè·³è¿‡å‘å¸ƒ"
            exit 1
          fi

      - name: ä¸‹è½½ LEDE ç‰ˆæœ¬å›ºä»¶
        uses: actions/download-artifact@main
        with:
          name: firmware-LEDE-FULL
          path: ./firmware-all

      - name: ä¸‹è½½ ImmortalWrt ç‰ˆæœ¬å›ºä»¶
        uses: actions/download-artifact@main
        with:
          name: firmware-ImmortalWrt-FULL
          path: ./firmware-all

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        id: release_vars
        run: |
          cd "$GITHUB_WORKSPACE"/firmware-all
          ls -lah
          echo "FILE_DATE=$(date +"%Y.%m.%d")" >> "$GITHUB_OUTPUT"

          # æå– LEDE å†…æ ¸ç‰ˆæœ¬
          if [ -f "LEDE_profiles.json" ]; then
            echo "LEDE_KERNEL_VERSION=$(grep "^kernel " LEDE_openwrt-x86-64-generic.manifest | awk '{split($3, a, "-"); print a[1]"-"a[2]}')" >> "$GITHUB_OUTPUT"
            echo "LEDE_FIRMWARE_VERSION=$(jq -r '.version_number // "unknown"' LEDE_profiles.json)" >> "$GITHUB_OUTPUT"
          else
            echo "LEDE_KERNEL_VERSION=unknown" >> "$GITHUB_OUTPUT"
            echo "LEDE_FIRMWARE_VERSION=unknown" >> "$GITHUB_OUTPUT"
          fi

          # æå– ImmortalWrt å†…æ ¸ç‰ˆæœ¬
          if [ -f "ImmortalWrt_profiles.json" ]; then
            echo "IMMORTAL_KERNEL_VERSION=$(jq -r '.linux_kernel.version // "unknown"' ImmortalWrt_profiles.json)" >> "$GITHUB_OUTPUT"
            echo "IMMORTAL_FIRMWARE_VERSION=$(jq -r '.version_number // "unknown"' ImmortalWrt_profiles.json)" >> "$GITHUB_OUTPUT"
          else
            echo "IMMORTAL_KERNEL_VERSION=unknown" >> "$GITHUB_OUTPUT"
            echo "IMMORTAL_FIRMWARE_VERSION=unknown" >> "$GITHUB_OUTPUT"
          fi

      - name: å‘å¸ƒå›ºä»¶è‡³ Release
        uses: softprops/action-gh-release@v2
        with:
          name: R${{ steps.release_vars.outputs.FILE_DATE }}_LEDE_ImmortalWrt_FULL_Combined
          tag_name: R${{ steps.release_vars.outputs.FILE_DATE }}_LEDE_ImmortalWrt_FULL_Combined
          token: ${{ secrets.GH_TOKEN }}
          files: ${{ github.workspace }}/firmware-all/*
          body: |
            **OpenWrt LEDE & ImmortalWrt ç»„åˆå›ºä»¶ï¼ˆå¹¶è¡Œç¼–è¯‘ï¼‰**

            ### ğŸ“‹ å›ºä»¶ä¿¡æ¯
            - ğŸ’» å¹³å°æ¶æ„: x86_64
            - ğŸ“¦ ç¼–è¯‘ç‰ˆæœ¬: LEDE + ImmortalWrt å®Œæ•´ç‰ˆç»„åˆ
            - âš½ å›ºä»¶æºç :
              - [LEDE](https://github.com/coolsnowwolf/lede)
              - [ImmortalWrt](https://github.com/immortalwrt/immortalwrt)
            - ğŸ’ æºç åˆ†æ”¯: master
            - ğŸ§ å†…æ ¸ç‰ˆæœ¬:
              - LEDE: ${{ steps.release_vars.outputs.LEDE_KERNEL_VERSION }}
              - ImmortalWrt: ${{ steps.release_vars.outputs.IMMORTAL_KERNEL_VERSION }}
            - ğŸŒ é»˜è®¤åœ°å€: 192.168.1.1
            - ğŸ”‘ é»˜è®¤å¯†ç : æ— 

            ### ğŸ“ æ–‡ä»¶è¯´æ˜
            - **LEDE_*** : LEDE å®Œæ•´ç‰ˆå›ºä»¶
            - **ImmortalWrt_*** : ImmortalWrt å®Œæ•´ç‰ˆå›ºä»¶

            ### ğŸ“ ç‰ˆæœ¬ä¿¡æ¯
            - LEDE: ${{ steps.release_vars.outputs.LEDE_FIRMWARE_VERSION }}
            - ImmortalWrt: ${{ steps.release_vars.outputs.IMMORTAL_FIRMWARE_VERSION }}

            ### ğŸ”— æºç æ›´æ–°è®°å½•
            **LEDE æºç :**
            - ${{ needs.prepare.outputs.lede_commit_author }}
            - ${{ needs.prepare.outputs.lede_commit_date }}
            - ${{ needs.prepare.outputs.lede_commit_message }}
            - ${{ needs.prepare.outputs.lede_commit_hash }}

            **ImmortalWrt æºç :**
            - ${{ needs.prepare.outputs.immortal_commit_author }}
            - ${{ needs.prepare.outputs.immortal_commit_date }}
            - ${{ needs.prepare.outputs.immortal_commit_message }}
            - ${{ needs.prepare.outputs.immortal_commit_hash }}
